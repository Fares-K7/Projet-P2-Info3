#!/bin/bash

if [ "$#" -lt 3 ]; then
    echo "Usage: $0 <fichier.csv> <histo|leaks> <param>"
    exit 1
fi

CSV="$1"
CMD="$2"
OPT="$3"
EXE="./c-wire"

if [ ! -f "$EXE" ]; then
    echo "Compilation..."
    make
    if [ $? -ne 0 ]; then exit 1; fi
fi

rm -f output/*.dat
mkdir -p tmp tests output

# Chrono Début (nanosecondes)
start=$(date +%s%N)

# Exécution C
"$EXE" "$CSV" "$CMD" "$OPT"
code=$?

if [ $code -ne 0 ]; then
    echo "Erreur C-Wire (Code $code)"
    exit $code
fi

# Traitement Graphique
if [ "$CMD" = "histo" ]; then
    DAT="output/vol_${OPT}.dat"
    
    if [ -f "$DAT" ]; then
        # Tri (ignorer header)
        tail -n +2 "$DAT" | sort -t';' -k2 -nr > tmp/sorted.dat
        
        # Top 10 Max
        head -n 10 tmp/sorted.dat > tmp/top10.dat
        # Bottom 50 Min
        tail -n 50 tmp/sorted.dat | sort -t';' -k2 -n > tmp/bot50.dat

        gnuplot -e "set terminal png size 1200,800; \
            set output 'tests/vol_${OPT}_top10.png'; \
            set title 'Top 10 Usines (${OPT})'; \
            set style data histograms; set style fill solid; \
            set datafile separator ';'; \
            set boxwidth 0.5; set xtic rotate by -45 scale 0; \
            set ylabel 'Volume (k.m3)'; \
            plot 'tmp/top10.dat' using 2:xtic(1) notitle"

        gnuplot -e "set terminal png size 1200,800; \
            set output 'tests/vol_${OPT}_bot50.png'; \
            set title 'Bottom 50 Usines (${OPT})'; \
            set style data histograms; set style fill solid; \
            set datafile separator ';'; \
            set boxwidth 0.5; set xtic rotate by -90 scale 0 font ',8'; \
            set ylabel 'Volume (k.m3)'; \
            plot 'tmp/bot50.dat' using 2:xtic(1) notitle"
            
        echo "Graphiques générés dans tests/"
    fi
fi

# Chrono Fin
end=$(date +%s%N)
if [ ${#start} -gt 15 ]; then
    dur=$(( (end - start) / 1000000 ))
else
    dur=0
fi
echo "Durée : ${dur} ms"
